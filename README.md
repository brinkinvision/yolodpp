<div align="center">
  <h2>Решение задачи детекции объектов на примере ручки и карандаша</h2>
</div>

Репозиторий содержит код и инструкции для обучения модели YOLO (версии 8) для детекции карандашей и ручек на видео. 

**Содержание:**

* [Задача](#задача)
* [Подготовка датасета](#подготовка-датасета)
* [Обучение модели YOLO](#обучение-модели-yolo)
* [Оценка метрик](#оценка-метрик)
* [Тестирование моделей](#тестирование-моделей)

### Задача

Обучить модель YOLO для распознавания карандашей и ручек на видео.

Этапы обучения состояли в:
- сборе и разметке данных;
- обучении предобученной модели;
- оценке производительности;
- тестировании качества полученной модели.

### Подготовка датасета:

Были записаны два 30-секундных видео:
* Видео для обучения [**`train.mp4`**](https://disk.yandex.ru/i/ws7i0-H_H-b9Xg) использовалось для тренировки модели.
* Видео для проверки [**`test.mp4`**](https://disk.yandex.ru/i/GPNmZZZ3zP1lRQ) применялось для оценки качества полученной модели. 

С помощью `ffmpeg` видео **train.mp4** было разбито на 60 фотографий.
```
ffmpeg -i train.mp4 -vf fps=2 images/img%02d.png
```

Далее эти фотографии прошли процедуру разметки в сервисе Roboflow на два класса **pen** и **pencil**. Размечались объекты с использованием `Bounding Box`. В обучающую выборку вошли 50 фотографий, в валидационную - 10. 

### Обучение модели YOLO

Были обучены две модели: `yolov8n` (nano) и `yolov8s` (small).

Обучение проводилось с использованием GPU на ноутбуке с видеокартой RTX 3070 8GB.

Инструкции обучения содержатся в файле [`train_and_detect.ipynb`](/train_and_detect.ipynb) репозитория.

### Оценка метрик

После завершения обучения получены следующие результаты:

**YOLOv8n (nano):**

| Class   | Images | Instances | Box(P) | R  | mAP50 | mAP50-95 |
| ------- | ------ | ---------- | ------ | -- | ----- | -------- |
| all     | 10     | 52         | 0.953  | 0.978 | 0.993 | 0.858    |
| pen     | 10     | 26         | 1      | 0.957 | 0.995 | 0.872    |
| pencil  | 10     | 26         | 0.906  | 1   | 0.991 | 0.845    |


**YOLOv8s (small):**

| Class   | Images | Instances | Box(P) | R  | mAP50 | mAP50-95 |
| ------- | ------ | ---------- | ------ | -- | ----- | -------- |
| all     | 10     | 52         | 0.942  | 1   | 0.988 | 0.874    |
| pen     | 10     | 26         | 0.999  | 1   | 0.995 | 0.877    |
| pencil  | 10     | 26         | 0.885  | 1   | 0.981 | 0.871    |


Модель nano при обучении потребляла ~ 2.2-2.4 Gb видеопамяти, модель small ~ 3.7-4.0 Gb. 

Время обучения:
- nano (0.027 часов)
- small (0.035 часов)

* Точность обнаруженных объектов (Precision) выше у модели nano.
* Полнота (Recall) выше у модели small, в части обнаружения карандашей обе модели показывают одинаковые результаты.
* По метрике mAP (средней точности) при mAP50 (легких обнаружениях) выигрывает модель nano, однако при пороговых значениях от 0.50 до 0.95 победа за моделью small.

Таким образом, учитывая результаты по метрикам и объем затрачиваемых ресурсов и скорость обучения в данном случае лучше выбрать модель nano. Очевидно, что при выборе из этих двух моделей, nano используется когда нужна скорость вычислений, а small необходима, если нужна более высокая точность.

### Тестирование моделей

Обученные модели для версий `nano` и `small` были протестированы на записанном втором видео и с использованием камеры ноутбука. 

Видео с результатами детекции:
- [**`detect_video_nano.mp4`**](https://disk.yandex.ru/i/OMGdQ5NPhYbzkg)
- [**`detect_video_small.mp4`**](https://disk.yandex.ru/i/FfM5dcn_6_Bjag) 

Демонстрация детекции в реальном времени:
- [**`detect_cam_nano.mp4`**](https://disk.yandex.ru/i/P4HR7I05hkWIfg)
- [**`detect_cam_small.mp4`**](https://disk.yandex.ru/i/P4HR7I05hkWIfg) 



