<div align="center">
  <h2>Решение задачи детекции объектов на примере ручки и карандаша</h2>
</div>

Репозиторий содержит код и инструкции для обучения модели YOLO (версии 8) для детекции карандашей и ручек на видео. 

**Содержание:**

* [Задача](#задача)
* [Подготовка датасета](#подготовка-датасета)
* [Обучение модели YOLO](#обучение-модели-yolo)
* [Оценка метрик](#оценка-метрик)
* [Тестирование моделей](#тестирование-моделей)
* [Выводы](#выводы)

### Задача

Обучить модель YOLO для распознавания карандашей и ручек на видео.

Этапы обучения состояли в:
- сборе и разметке данных;
- обучении предобученной модели;
- оценке производительности;
- тестировании качества полученной модели.

### Подготовка датасета:

Были записаны два 30-секундных видео:
* Видео для обучения [**`train.mp4`**](https://disk.yandex.ru/i/L453EMbULq3qEA) использовалось для тренировки модели.
* Видео для проверки [**`test.mp4`**](https://disk.yandex.ru/i/2xJRTBheJf9npA) применялось для оценки качества полученной модели. 

С помощью `ffmpeg` видео **train.mp4** было разбито на 60 фотографий.
```
ffmpeg -i train.mp4 -vf fps=2 images/img%02d.png
```

Далее эти фотографии прошли процедуру разметки в сервисе Roboflow на два класса **pen** и **pencil**. Размечались объекты с использованием `Bounding Box`. В обучающую выборку вошли 50 фотографий, в валидационную - 10. 


[`Ссылка на размеченный датасет`](https://universe.roboflow.com/penandpencildraft/penandpencil/dataset/1)


### Обучение модели YOLO

Были дообучены две модели: `yolov8n` (nano) и `yolov8s` (small).

Обучение проводилось с использованием GPU на ноутбуке с видеокартой NVIDIA GeForce RTX 3070 8GB.

Программный код содержится в файле [`train_and_detect.ipynb`](/train_and_detect.ipynb) репозитория.

### Оценка метрик

После завершения обучения получены следующие результаты:

**YOLOv8n (nano):**

| Class   | Images | Instances | Box(P) | R  | mAP50 | mAP50-95 |
| ------- | ------ | ---------- | ------ | -- | ----- | -------- |
| all     | 10     | 48         | 0.921  | 0.976 | 0.987 | 0.854   |
| pen     | 10     | 23         | 0.881  | 0.967 | 0.98  | 0.85    |
| pencil  | 10     | 25         | 0.961  | 0.986 | 0.993 | 0.858    |


**YOLOv8s (small):**

| Class   | Images | Instances | Box(P) | R  | mAP50 | mAP50-95 |
| ------- | ------ | ---------- | ------ | -- | ----- | -------- |
| all     | 10     | 48         | 0.986  | 0.978 | 0.994 | 0.856    |
| pen     | 10     | 23         | 0.979  | 0.957 | 0.993 | 0.865    |
| pencil  | 10     | 25         | 0.994  | 1     | 0.995 | 0.846    |


Модель nano при обучении потребляла ~ 2.1-3.0 Gb видеопамяти, модель small ~ 3.8-4.1 Gb. 

Время обучения:
- nano (0.027 часов)
- small (0.035 часов)

Метрики:
* Точность обнаруженных объектов (Precision) выше у модели small.
* Полнота (Recall) выше для pencil у модели small, для pen незначительно выше у модели nano.
* По метрике mAP (средней точности) при mAP50 (легких обнаружениях) выигрывает модель small. При пороговых значениях от 0.50 до 0.95 результат для pencil немного выше у модели nano.

Очевидно, что при выборе из этих двух моделей, nano используется когда нужна скорость вычислений, а small необходима, если нужна более высокая точность. Результаты по метрикам доказывают это утверждение.

### Тестирование моделей

Обученные модели для версий `nano` и `small` были протестированы на записанном втором видео и с использованием камеры ноутбука. 

Результаты детекции на тестовом видео:
- [**`detect_video_nano.mp4`**](https://disk.yandex.ru/i/QlThdMVwnyvpeQ)
- [**`detect_video_small.mp4`**](https://disk.yandex.ru/i/QFhY5RuZiE1amw) 

Демонстрация детекции в реальном времени:
- [**`detect_cam_nano.mp4`**](https://disk.yandex.ru/i/VZKOtUTpibHgXQ)
- [**`detect_cam_small.mp4`**](https://disk.yandex.ru/i/tCemj-4yOBJb8A) 

### Выводы

- При оценке метрик лучше модель small. 
- При детекции на тестовом видео видно, что модель small может захватывать при детекции более дальние объекты. В то время как nano уже не может захватить объекты на некотором удаленном расстоянии. Отличие в детекции состоит в этом. Если не учитывать это, то обе модели показывают похожие результаты.
- При тестировании через камеру в реальном времени уже видна значительная разница между моделями. Модель nano плохо захватывает объекты на некотором удалении и практически всегда принимает карандаш за ручку. В это же время модель small хорошо отличает карандаш и ручку, сразу захватывает необходимые для детекции объекты. Недостатком является лишь, что она детектирует участки на фоне как объекты детекции, что можно исправить дообучением на более обширном датасете.





